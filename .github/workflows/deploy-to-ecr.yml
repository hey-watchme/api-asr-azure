# Vibe Analysis Transcriber API - ECR & EC2 è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: Deploy to Amazon ECR and EC2

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°
on:
  # mainãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ
  push:
    branches: [ "main" ]
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

# ç’°å¢ƒå¤‰æ•°
env:
  AWS_REGION: ap-southeast-2
  ECR_REPOSITORY: watchme-vibe-analysis-transcriber

# ã‚¸ãƒ§ãƒ–ã®å®šç¾©
jobs:
  deploy:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    
    steps:
    # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout code
      uses: actions/checkout@v4

    # ã‚¹ãƒ†ãƒƒãƒ—2: AWSèªè¨¼æƒ…å ±ã®è¨­å®š
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # ã‚¹ãƒ†ãƒƒãƒ—3: ECRã¸ã®ãƒ­ã‚°ã‚¤ãƒ³
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # ã‚¹ãƒ†ãƒƒãƒ—4: Docker Buildxã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œï¼‰
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ã‚¹ãƒ†ãƒƒãƒ—5: ECRã‹ã‚‰å¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã ãŒæ¨å¥¨ï¼‰
    - name: Delete old images from ECR
      run: |
        aws ecr batch-delete-image \
          --region ${{ env.AWS_REGION }} \
          --repository-name ${{ env.ECR_REPOSITORY }} \
          --image-ids imageTag=latest || true

    # ã‚¹ãƒ†ãƒƒãƒ—6: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã€ã‚¿ã‚°ä»˜ã‘ã€ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆARM64å¯¾å¿œï¼‰
    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # ARM64ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç”¨ã«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ï¼‰
        docker buildx build \
          --platform linux/arm64 \
          --no-cache \
          --push \
          -f Dockerfile.prod \
          -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG \
          -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest \
          .

        echo "âœ… Image pushed to ECR:"
        echo "  - $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG"
        echo "  - $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest"

    # ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
    - name: Deploy Success Notification
      if: success()
      run: |
        echo "ğŸ‰ Deployment to ECR succeeded!"
        echo "ğŸ“¦ Repository: ${{ env.ECR_REPOSITORY }}"
        echo "ğŸ·ï¸ Image Tag: ${{ github.sha }}"
        echo "ğŸ“ Region: ${{ env.AWS_REGION }}"
        echo ""
        echo "ğŸ“‹ Next Steps:"
        echo "1. SSH to EC2: ssh -i ~/watchme-key.pem ubuntu@3.24.16.82"
        echo "2. Deploy: cd /home/ubuntu/vibe-analysis-transcriber && ./run-prod.sh"

    # ã‚¹ãƒ†ãƒƒãƒ—6: ã‚¨ãƒ©ãƒ¼æ™‚ã®é€šçŸ¥
    - name: Deploy Failure Notification
      if: failure()
      run: |
        echo "âŒ Deployment to ECR failed!"
        echo "Please check the logs above for details."

  # ã‚¸ãƒ§ãƒ–2: CD - EC2ã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-to-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    # é‡è¦: deploy ã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ãŸå¾Œã«ã®ã¿å®Ÿè¡Œ
    needs: deploy

    steps:
    # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ã«å¿…è¦ï¼‰
    - name: Checkout code
      uses: actions/checkout@v4

    # ã‚¹ãƒ†ãƒƒãƒ—2: SSHã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

    # ã‚¹ãƒ†ãƒƒãƒ—3: Known Hostsã®è¿½åŠ ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šï¼‰
    - name: Add EC2 to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    # ã‚¹ãƒ†ãƒƒãƒ—4: EC2ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆã¹ãç­‰æ€§ç¢ºä¿ï¼‰
    - name: Create application directory on EC2 if not exists
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        ssh ${EC2_USER}@${EC2_HOST} "mkdir -p /home/ubuntu/vibe-analysis-transcriber"

    # ã‚¹ãƒ†ãƒƒãƒ—5: docker-compose.prod.ymlã¨run-prod.shã‚’EC2ã«ã‚³ãƒ”ãƒ¼
    - name: Copy configuration files to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        scp docker-compose.prod.yml ${EC2_USER}@${EC2_HOST}:/home/ubuntu/vibe-analysis-transcriber/
        scp run-prod.sh ${EC2_USER}@${EC2_HOST}:/home/ubuntu/vibe-analysis-transcriber/
        ssh ${EC2_USER}@${EC2_HOST} "chmod +x /home/ubuntu/vibe-analysis-transcriber/run-prod.sh"

    # ã‚¹ãƒ†ãƒƒãƒ—6: EC2ã«.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ/æ›´æ–°ï¼ˆâ˜…é‡è¦: ç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼‰
    - name: Create/Update .env file on EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        # Supabaseè¨­å®š
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        # AWS S3è¨­å®š
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        S3_BUCKET_NAME: watchme-vault
        AWS_REGION: us-east-1
        # Azure Speech Serviceè¨­å®š
        AZURE_SPEECH_KEY: ${{ secrets.AZURE_SPEECH_KEY }}
        AZURE_SERVICE_REGION: ${{ secrets.AZURE_SERVICE_REGION }}
        # Groq APIè¨­å®š
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        # Deepgram APIè¨­å®š
        DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
        # aiOla APIè¨­å®š
        AIOLA_API_KEY: ${{ secrets.AIOLA_API_KEY }}
      run: |
        ssh ${EC2_USER}@${EC2_HOST} << ENDSSH
          cd /home/ubuntu/vibe-analysis-transcriber
          echo "SUPABASE_URL=${SUPABASE_URL}" > .env
          echo "SUPABASE_KEY=${SUPABASE_KEY}" >> .env
          echo "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" >> .env
          echo "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" >> .env
          echo "S3_BUCKET_NAME=${S3_BUCKET_NAME}" >> .env
          echo "AWS_REGION=${AWS_REGION}" >> .env
          echo "AZURE_SPEECH_KEY=${AZURE_SPEECH_KEY}" >> .env
          echo "AZURE_SERVICE_REGION=${AZURE_SERVICE_REGION}" >> .env
          echo "GROQ_API_KEY=${GROQ_API_KEY}" >> .env
          echo "DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}" >> .env
          echo "AIOLA_API_KEY=${AIOLA_API_KEY}" >> .env
        ENDSSH

    # ã‚¹ãƒ†ãƒƒãƒ—7: å¤ã„Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºä¿ï¼‰
    - name: Clean up old Docker images on EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        echo "ğŸ§¹ Cleaning up old Docker images..."

        ssh ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          echo "ğŸ“Š Disk usage before cleanup:"
          df -h | grep /dev/root

          echo "ğŸ—‘ï¸ Removing unused Docker images..."
          docker image prune -a -f || true

          echo "ğŸ“Š Disk usage after cleanup:"
          df -h | grep /dev/root
        ENDSSH

        echo "âœ… Cleanup completed"

    # ã‚¹ãƒ†ãƒƒãƒ—8: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
    - name: Deploy to EC2 instance
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        echo "ğŸš€ Starting deployment to EC2..."

        # SSHã§EC2ã«æ¥ç¶šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        ssh ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          set -e
          echo "ğŸ“¦ Navigating to application directory..."
          cd /home/ubuntu/vibe-analysis-transcriber

          echo "ğŸ”„ Running deployment script..."
          ./run-prod.sh

          echo "âœ… Deployment script completed"

          # ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ç¢ºèª
          echo "ğŸ“Š Checking container status..."
          docker ps | grep vibe-analysis-transcriber || echo "âš ï¸ Container not found"

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          echo "ğŸ¥ Running health check..."
          sleep 5
          curl -f http://localhost:8013/health || echo "âš ï¸ Health check failed"
        ENDSSH

        echo "âœ… EC2 deployment completed successfully!"

    # ã‚¹ãƒ†ãƒƒãƒ—9: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
    - name: Deployment Success Notification
      if: success()
      run: |
        echo "ğŸ‰ Full CI/CD pipeline completed successfully!"
        echo "ğŸ“¦ Service: vibe-analysis-transcriber"
        echo "ğŸŒ URL: https://api.hey-watch.me/vibe-analysis/transcriber/"
        echo "ğŸ·ï¸ Version: ${{ github.sha }}"
        echo "ğŸ¤– ASR Provider: groq/whisper-large-v3-turbo"

    # ã‚¹ãƒ†ãƒƒãƒ—10: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
    - name: Deployment Failure Notification
      if: failure()
      run: |
        echo "âŒ EC2 deployment failed!"
        echo "Please check the SSH connection and server logs."